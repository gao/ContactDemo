<!DOCTYPE html>
<!--
 * Copyright (c) 2009 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
	<head>
		<script type="text/javascript" src="js/chrome_ex_oauthsimple.js"></script>
		<script type="text/javascript" src="js/chrome_ex_oauth.js"></script>
		<script type="text/javascript">
			var oauth = ChromeExOAuth.initBackgroundPage({
				'request_url' : 'https://www.google.com/accounts/OAuthGetRequestToken',
				'authorize_url' : 'https://www.google.com/accounts/OAuthAuthorizeToken',
				'access_url' : 'https://www.google.com/accounts/OAuthGetAccessToken',
				'consumer_key' : 'anonymous',
				'consumer_secret' : 'anonymous',
				'scope' : 'http://www.google.com/m8/feeds/',
				'app_name' : 'Sample - OAuth Contacts'
				});

			var contacts = null;
			var groups = null;
			var hasGetContactsData = false;
			var hasGetGroupsData = false;

			function onContacts(text, xhr,callback) {
				contacts = [];
				var data = JSON.parse(text);
				for (var i = 0, entry; entry = data.feed.entry[i]; i++) {
					var contact = {
						'name' : entry['title']['$t'],
						'id' : entry['id']['$t'],
						'emails' : [],
						'groupIds' : []
					};

					if (entry['gd$email']) {
						var emails = entry['gd$email'];
						for (var j = 0, email; email = emails[j]; j++) {
							contact['emails'].push(email['address']);
						}
					 }

					if (!contact['name']) {
						contact['name'] = contact['emails'][0] || "<Unknown>";
					}
					
					if (entry['gContact$groupMembershipInfo']) {
						var groupIds = entry['gContact$groupMembershipInfo'];
						for (var m = 0, groupId; groupId = groupIds[m]; m++) {
							contact['groupIds'].push(groupId['href']);
						}
					 }

					contacts.push(contact);
		  
					localStorage.contacts = JSON.stringify(contacts);
				}

				hasGetContactsData = true;
				if(hasGetContactsData && hasGetGroupsData){
		  			if(callback){
						callback();
					}
				}
			};

			function onGroups(text, xhr,callback) {
				groups = [];
				var data = JSON.parse(text);
				for (var i = 0, entry; entry = data.feed.entry[i]; i++) {
					var group = {
						'name' : entry['title']['$t'],
						'id' : entry['id']['$t']
					};

					groups.push(group);
					localStorage.groups = JSON.stringify(groups);
				}

				hasGetGroupsData = true;
				if(hasGetContactsData && hasGetGroupsData){
		  			if(callback){
						callback();
					}
				}
			};

			function getData(callback){
				getContacts(callback);
				getGroups(callback);
			}

			function getGroups(callback) {
	  			var callbackData = function(text,xhr){
						onGroups(text,xhr,callback);
					}

				oauth.authorize(function() {
					//console.log("on authorize");
					var url = "http://www.google.com/m8/feeds/groups/default/full";
					oauth.sendSignedRequest(url, callbackData, {
						'parameters' : {
							'alt' : 'json',
							'max-results' : 100
						}
					});
				});
			};

			function getContacts(callback) {
	  			var callbackData = function(text,xhr){
						onContacts(text,xhr,callback);
					}

				oauth.authorize(function() {
					//console.log("on authorize");
					var url = "http://www.google.com/m8/feeds/contacts/default/full";
					oauth.sendSignedRequest(url, callbackData, {
						'parameters' : {
							'alt' : 'json',
							'max-results' : 100
						}
					});
				});
			};

			function getToken(callback) {
	  			var callbackData = function(){
						getData(callback);
					}

				oauth.authorize(function() {
					var url = "http://www.google.com/m8/feeds";
					oauth.sendSignedRequest(url, callbackData, {});
				});
			};

			function logout() {
				oauth.clearTokens();
			};

		</script>
	</head>

	<body>
	</body>
</html>
